<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Chat Seguro con DH</title>
  <style>
    .hidden { display: none; }
    #chatBox { border: 1px solid #ccc; height: 300px; overflow-y: scroll; padding: 10px; }
  </style>
</head>
<body>
  <div id="loginForm">
    <h2>Iniciar sesión</h2>
    <input type="text" id="username" placeholder="Nombre de usuario" />
    <button onclick="loginUser()">Entrar</button>
  </div>

  <div id="chatInterface" class="hidden">
    <h2>Bienvenido, <span id="userDisplay"></span></h2>

    <div>
      <p>Tu clave pública: <span id="myPublicKey"></span></p>
      <input type="text" id="otherPublicKey" placeholder="Clave pública del otro usuario" />
      <button onclick="simulateKeyExchange()">Intercambiar clave</button>
    </div>

    <div id="keyStatus" class="hidden">
      <p><strong>Intercambio realizado con éxito.</strong></p>
      <p id="sharedKey"></p>
    </div>

    <div id="chatBox"></div>

    <input type="text" id="chatMessage" placeholder="Escribe un mensaje" />
    <button onclick="sendMessage()">Enviar</button>
  </div>

  <script>
    let username = "";

    function loginUser() {
      username = document.getElementById('username').value;
      if (!username) return;

      fetch('/key-exchange', {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: 'action=init&username=' + encodeURIComponent(username)
      })
      .then(res => res.text())
      .then(publicKey => {
        document.getElementById('loginForm').classList.add('hidden');
        document.getElementById('chatInterface').classList.remove('hidden');
        document.getElementById('userDisplay').innerText = username;
        document.getElementById('myPublicKey').innerText = publicKey;
        loadMessages();
      });
    }

    function simulateKeyExchange() {
      const otherKey = document.getElementById('otherPublicKey').value;
      if (!otherKey) {
        alert("Ingresa una clave pública válida");
        return;
      }

      fetch('/key-exchange', {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: 'action=exchange&otherPublicKey=' + encodeURIComponent(otherKey)
      })
      .then(res => res.text())
      .then(sharedKey => {
        document.getElementById('keyStatus').classList.remove('hidden');
        document.getElementById('sharedKey').innerText = "Clave compartida: " + sharedKey;
      });
    }

    function sendMessage() {
      const msg = document.getElementById('chatMessage').value.trim();
      if (!msg) return;

      fetch('/chat', {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: 'message=' + encodeURIComponent(msg)
      })
      .then(() => {
        document.getElementById('chatMessage').value = '';
        loadMessages();
      });
    }

    function loadMessages() {
      fetch('/chat-messages')
        .then(res => res.json())
        .then(messages => {
          const chatBox = document.getElementById('chatBox');
          chatBox.innerHTML = messages.map(m => `<div>${m}</div>`).join('');
          chatBox.scrollTop = chatBox.scrollHeight;
        });
    }
  </script>
</body>
</html>
